<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Walkie Talkie</title>
</head>
<body style="font-family:sans-serif; text-align:center; padding:40px;">
<h2>Family Walkie Talkie</h2>

<input id="room" placeholder="Room name" value="family" /><br><br>
<button onclick="join()">Join</button>

<br><br>
<button id="talkBtn" style="padding:30px 60px; font-size:18px;" disabled>
Hold to Talk
</button>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
let socket, stream, peers = {};
let audioCtx, sourceNode, gainNode;

async function join() {
  const room = document.getElementById("room").value;

  // Always send the microphone stream
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  // Create audio context to control volume (push-to-talk)
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  sourceNode = audioCtx.createMediaStreamSource(stream);
  gainNode = audioCtx.createGain();
  gainNode.gain.value = 0; // start muted
  sourceNode.connect(gainNode).connect(audioCtx.destination);

  socket = io("https://family-walkie-server.onrender.com");

  socket.on("connect", () => socket.emit("join", { room }));
  socket.on("user-joined", id => addPeer(id, true));
  socket.on("user-left", id => peers[id]?.destroy());
  socket.on("signal", ({ source, data }) => peers[source]?.signal(data));

  const btn = document.getElementById("talkBtn");
  btn.disabled = true;
  setTimeout(() => btn.disabled = false, 500);

  function startTalking() {
    audioCtx.resume();
    gainNode.gain.value = 1; // unmute
  }
  function stopTalking() {
    gainNode.gain.value = 0; // mute
  }

  btn.onmousedown = startTalking;
  btn.onmouseup = stopTalking;
  btn.ontouchstart = startTalking;
  btn.ontouchend = stopTalking;
}

function addPeer(id, initiator) {
  const peer = new SimplePeer({
    initiator,
    stream,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        {
          urls: 'turn:global.relay.metered.ca:80',
          username: 'open',
          credential: 'open'
        }
      ]
    }
  });

  peers[id] = peer;

  peer.on("signal", data => socket.emit("signal", { target: id, data }));

  peer.on("stream", remote => {
    const audio = document.createElement("audio");
    audio.srcObject = remote;
    audio.autoplay = true;
    audio.playsInline = true;
    audio.muted = false;
    document.body.appendChild(audio);

    audio.play().catch(() => {
      window.addEventListener("click", () => audio.play(), { once: true });
      window.addEventListener("touchstart", () => audio.play(), { once: true });
    });
  });
}
</script>

</body>
</html>
